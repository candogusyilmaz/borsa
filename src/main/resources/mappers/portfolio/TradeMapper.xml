<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.canverse.stocks.repository.TradeMapper">
    <resultMap id="TransactionInfo" type="dev.canverse.stocks.service.portfolio.model.TradeInfo">
        <id column="id" property="id"/>
        <result column="type" property="type"/>
        <result column="quantity" property="quantity"/>
        <result column="price" property="price"/>
        <result column="new_total" property="newTotal"/>
        <result column="new_quantity" property="newQuantity"/>
        <result column="profit" property="profit"/>
        <result column="action_date" property="actionDate"/>
        <result column="tags" property="tags" typeHandler="dev.canverse.stocks.repository.mybatis.JsonbTypeHandler"/>
        <association property="position"
                     javaType="dev.canverse.stocks.service.portfolio.model.TradeInfo$PositionView">
            <id column="position_id" property="positionId"/>
            <result column="instrument_symbol" property="instrumentSymbol"/>
            <result column="currency_code" property="currencyCode"/>
            <association property="portfolio"
                         javaType="dev.canverse.stocks.service.portfolio.model.TradeInfo$PositionView$PortfolioView">
                <id column="portfolio_id" property="id"/>
                <result column="portfolio_name" property="name"/>
            </association>
        </association>
    </resultMap>
    <select id="fetchTrades" resultMap="TransactionInfo" parameterType="long">
        select t.id,
               t.position_id,
               t.type,
               t.quantity,
               t.price,
               t.new_total,
               t.new_quantity,
               tp.profit,
               t.action_date,
               t.metadata ->> 'tags'     as tags,
               t.metadata ->> 'notes'    as notes,
               ins.symbol                as instrument_symbol,
               ins.denomination_currency as currency_code,
               pf.id                     as portfolio_id,
               pf.name                   as portfolio_name
        from portfolio.transactions t
                 join portfolio.positions pos on t.position_id = pos.id
                 join instrument.instruments ins on pos.instrument_id = ins.id
                 join portfolio.portfolios pf on pf.id = pos.portfolio_id and pf.archived = false
                 left join portfolio.transaction_performance tp on tp.transaction_id = t.id
        where pf.user_id = #{userId}
    </select>
    <select id="fetchActiveTrades" resultMap="TransactionInfo">
        with last_closed as (select coalesce(max(id), 0) as id
                             from portfolio.transactions
                             where position_id = #{positionId}
                               and new_quantity = 0)
        select t.id,
               t.position_id,
               t.type,
               t.quantity,
               t.price,
               t.new_total,
               t.new_quantity,
               tp.profit,
               t.action_date,
               t.metadata ->> 'tags'     as tags,
               t.metadata ->> 'notes'    as notes,
               ins.symbol                as instrument_symbol,
               ins.denomination_currency as currency_code,
               pf.id                     as portfolio_id,
               pf.name                   as portfolio_name
        from portfolio.transactions t
                 join portfolio.positions pos on t.position_id = pos.id
                 join portfolio.portfolios pf on pf.id = pos.portfolio_id and pf.archived = false
                 join instrument.instruments ins on pos.instrument_id = ins.id
                 left join portfolio.transaction_performance tp on tp.transaction_id = t.id
                 cross join last_closed lc
        where t.id > lc.id
          and pos.id = #{positionId}
          and pf.user_id = #{userId}
    </select>
</mapper>
